<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/jsSHA/src/sha.js"></script>

<dom-module id="stitch-order-request">
	<template>
		<iron-ajax on-response="_handleResponse"
		           debounce-duration="300">
		</iron-ajax>
	</template>
	<script>
	  (function(){
		'use strict';

		Polymer({
		  is: 'stitch-order-request',

		  /**
		   * Fired when a request is sent.
		   *
		   * @event order-request
		   */

		  /**
		   * Fired when a response is received.
		   *
		   * @event order-response
		   */

		  /**
		   * Fired when an error is received.
		   *
		   * @event error
		   */

		  properties: {
			/**
			 * The Amazon Access Key Id.
			 */
			accessKeyID: String,
			/**
			 * The Amazon Associate Tag.
			 */
			associateTag: String,
			/**
			 * The Amazon Secret Access Key.
			 * Required
			 */
			secretAccessKey: String,

			/**
			 * The URL target of the request.
			 */
			productUrl: String,

			/**
			 * productUrl's response.
			 *
			 * Note that productDetails is set when productUrl finishes, and the
			 * corresponding parse is made.
			 *
			 * The response is parsed as a JSON Object from the XML response
			 * returned by Amazon
			 *
			 * @type {Object}
			 */
			productDetails: {
			  type: Object,
			  notify: true
			}
		  },

		  observers: [
			'_setRequestParams(productUrl, accessKeyID, associateTag, secretAccessKey)'
		  ],

		  attached: function(){
			this.secretAccessKey = 'qSgTh1+jiDkga1Tt/ql8EcnS/ze6gHP6W+oqHlQn';
			this.associateTag = 'buttonjoy-20';
			this.accessKeyID = 'AKIAIO5T5P757JAH47QA';
		  },

		  _setRequestParams: function(productUrl, accessKeyID, associateTag, secretAccessKey){
			this.debounce('requesting-product', function(){
			  if (productUrl.length > 23 && accessKeyID && associateTag && secretAccessKey) {
				var ajax = this.$$('iron-ajax');
				var itemID = this._getItemIdFromURL(productUrl);
				var query = _service.paramsAsQuery(itemID, accessKeyID, associateTag);
				var url = this._signedUrl(_service.url(), query, secretAccessKey);

				ajax.set('url', url);
				var request = ajax.generateRequest();
				this.fire('order-request', {url: url, itemId: itemID});
			  }
			}, 300);
		  },

		  _handleResponse: function(e){
			var response = e.detail.response;
			console.log(response);
			this.fire('order-response', response);
		  },

		  _getItemIdFromURL: function(url){
			var regex = /\/dp\/(\w+)\//;
			return regex.exec(url)[1];
		  },
		  _signString: function(stringToSignParam, secret){
			var shaObj = new jsSHA('SHA-256', 'TEXT');
			shaObj.setHMACKey(secret, 'TEXT');
			shaObj.update(stringToSignParam);
			var signature = shaObj.getHMAC('B64');
			return encodeURIComponent(signature);
		  },
		  _signedUrl: function(url, canonicalizedQueryString, secret){
			var parser = document.createElement('a');
			parser.href = url;
			var hostname = parser.hostname;
			var pathname = parser.pathname;
			var stringToSign = ['GET', hostname, pathname, canonicalizedQueryString].join('\n');

			return url + '?' + [canonicalizedQueryString, 'Signature=' + this._signString(stringToSign, secret)].join('&');
		  }
		});

		var _service = (function(){
		  var awsUrl = 'http://webservices.amazon.com/onca/xml';

		  var params = {
			Service: 'AWSECommerceService',
			Operation: 'ItemLookup',
			IdType: 'ASIN',
			ResponseGroup: ['Images', 'ItemAttributes', 'Offers']
		  };

		  return {
			params: function(itemID, accessKeyID, associateTag){
			  var requestParams = JSON.parse(JSON.stringify(params));
			  requestParams.ItemId = itemID;
			  requestParams.AWSAccessKeyId = accessKeyID;
			  requestParams.AssociateTag = associateTag;

			  return requestParams;
			},
			query: function(params, timestampParam){
			  var query = [];
			  for (var param in params) {
				if (params.hasOwnProperty(param)) {
				  query.push(param + '=' + params[param]);
				}
			  }

			  var tiemstamp = timestampParam || new Date().toISOString();
			  query = query.join('&').replace(/,/g, '%2C').split('&');
			  query.push('Timestamp=' + encodeURIComponent(tiemstamp));

			  return query.sort().join('&');
			},
			paramsAsQuery: function(itemID, accessKeyID, associateTag, timestampParam){
			  return this.query(this.params(itemID, accessKeyID, associateTag, timestampParam));
			},
			url: function(query){
			  if (query instanceof Object) {
				query = this.query(query);
			  }

			  return awsUrl + (query ? '?' + query : '');
			}
		  }
		})();
	  })();
	</script>
</dom-module>
