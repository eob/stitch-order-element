<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/jsSHA/src/sha.js"></script>

<dom-module id="stitch-order-request">
	<template>
		<iron-ajax url="[[request.endpoint]]" method="POST"
		           content-type="application/json"
		           on-response="_handleResponse"
		           debounce-duration="300">
		</iron-ajax>
	</template>
	<script>
	  (function(){
		'use strict';

		Polymer({
		  is: 'stitch-order-request',

		  /**
		   * Fired when a request is sent.
		   *
		   * @event order-request
		   */

		  /**
		   * Fired when a response is received and parsed.
		   *
		   * @event order-response
		   */

		  /**
		   * Fired when an error is received.
		   *
		   * @event error
		   */

		  properties: {
			/**
			 * The URL target of the request.
			 */
			productUrl: {
			  type: String,
			  observer: '_setRequestParams'
			},

			/**
			 * productUrl's response.
			 *
			 * Note that productDetails is set when productUrl finishes, and the
			 * corresponding parse is made.
			 *
			 * The response is parsed as a JSON Object from the XML response
			 * returned by Amazon
			 *
			 * @type {Object}
			 */
			productDetails: {
			  type: Object,
			  notify: true,
			  value: {}
			}
		  },

		  ready: function(){
			this.request = (function(){
			  var endpoint = 'https://kc5nsidmrk.execute-api.us-west-2.amazonaws.com/production/item/lookup';

			  var body = {
				itemId: undefined,  //Required, extracted from amazon product URL
				ResponseGroup: 'Images,ItemAttributes,OfferListings,Offers'
			  };

			  return {
				body: function(itemId){
				  var request = JSON.parse(JSON.stringify(body));
				  request.itemId = itemId;

				  return request;
				},
				get endpoint(){
				  return endpoint;
				}
			  };
			})();
		  },

		  _setRequestParams: function(productUrl){
			this.debounce('requesting-product', function(){
			  if (productUrl.length > 23) {
				var ajax = this.$$('iron-ajax');
				var itemID = this._getItemIdFromURL(productUrl);

				ajax.set('body', this.request.body(itemID));
				ajax.generateRequest();

				this.fire('order-request', {itemId: itemID});
			  }
			}, 300);
		  },

		  _handleResponse: function(e){
			var response = e.detail.response[0];
			var product = {
			  id: response.ASIN[0],
			  title: response.ItemAttributes[0].Title[0],
			  image: response.MediumImage[0].URL[0],
			  cost: response.ItemAttributes[0].ListPrice[0].FormattedPrice[0],
			  prime: !!Number(response.Offers[0].Offer[0].OfferListing[0].IsEligibleForPrime[0])
			};

			this.set('productDetails', product);
			this.fire('order-response', product);
		  },

		  _getItemIdFromURL: function(url){
			var regex = /\/dp\/(\w+)\/?/;
			return regex.exec(url)[1];
		  }
		});
	  })();
	</script>
</dom-module>
